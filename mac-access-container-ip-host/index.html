<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>從 mac 使用 Container Ip 直連 - Yowko&#39;s Notes</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content="Yowko Tsai"><meta name=description content="從 mac 使用 Container Ip 直連 大約一年前開發環境從 Windows 轉換至 mac 後，開發上最痛苦的就是沒有 Visual Studio 可以用，痛苦指數第二高的我個人認為是 Docker for Mac 沒有 docker0 網卡 (這是已知的"><meta name=keywords content=yowko,.net,blog><meta name=generator content="Hugo 0.56.3"><meta name=msvalidate.01 content=FA1ADBDB8F0BBBD0F7F4E65CDEBF7898><link rel=canonical href=https://blog.yowko.com/mac-access-container-ip-host/><link rel=apple-touch-icon sizes=180x180 href=https://blog.yowko.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.yowko.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.yowko.com/favicon-16x16.png><link rel=manifest href=https://blog.yowko.com/manifest.json><link rel=mask-icon href=https://blog.yowko.com/safari-pinned-tab.svg color=#5bbad5><link href="https://blog.yowko.com/dist/even.min.css?v=3.2.0" rel=stylesheet><link href=https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.css rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><meta property=og:title content="從 mac 使用 Container Ip 直連"><meta property=og:description content="從 mac 使用 Container Ip 直連 大約一年前開發環境從 Windows 轉換至 mac 後，開發上最痛苦的就是沒有 Visual Studio 可以用，痛苦指數第二高的我個人認為是 Docker for Mac 沒有 docker0 網卡 (這是已知的"><meta property=og:type content=article><meta property=og:url content=https://blog.yowko.com/mac-access-container-ip-host/><meta property=article:published_time content=2019-12-22T22:30:00+08:00><meta property=article:modified_time content=2020-12-11T22:30:31+08:00><meta itemprop=name content="從 mac 使用 Container Ip 直連"><meta itemprop=description content="從 mac 使用 Container Ip 直連 大約一年前開發環境從 Windows 轉換至 mac 後，開發上最痛苦的就是沒有 Visual Studio 可以用，痛苦指數第二高的我個人認為是 Docker for Mac 沒有 docker0 網卡 (這是已知的"><meta itemprop=datePublished content=2019-12-22T22:30:00&#43;08:00><meta itemprop=dateModified content=2020-12-11T22:30:31&#43;08:00><meta itemprop=wordCount content=1054><meta itemprop=keywords content=macOS,Tools,Helm,Kubernetes,Docker,><meta name=twitter:card content=summary><meta name=twitter:title content="從 mac 使用 Container Ip 直連"><meta name=twitter:description content="從 mac 使用 Container Ip 直連 大約一年前開發環境從 Windows 轉換至 mac 後，開發上最痛苦的就是沒有 Visual Studio 可以用，痛苦指數第二高的我個人認為是 Docker for Mac 沒有 docker0 網卡 (這是已知的"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><link href=https://blog.yowko.com/opensearch.xml rel=search title="Content search" type=application/opensearchdescription+xml></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=https://blog.yowko.com/ class=logo>Yowko&#39;s Notes</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=https://blog.yowko.com/><li class=mobile-menu-item>首頁</li></a><a href=https://blog.yowko.com/post/><li class=mobile-menu-item>歷史筆記</li></a><a href=https://blog.yowko.com/tags/><li class=mobile-menu-item>內容標籤</li></a><a href=https://blog.yowko.com/search><li class=mobile-menu-item>站內搜尋</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header style=height:118px;padding-bottom:0><div class=logo-wrapper><a href=https://blog.yowko.com/ class=logo>Yowko&#39;s Notes</a></div><div style=padding-bottom:60px></div></nav><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/>首頁</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/post/>歷史筆記</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/tags/>內容標籤</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/search>站內搜尋</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><hr style="border-top:1px solid #e6e6e6;border-bottom:0;padding:0"><div id=content class=content><article class=post><header class=post-header><div class=post-meta><span class=post-time>2019-12-22</span>
<span class=more-meta>約 1054 字</span>
<span class=more-meta>預計閱讀 3 分鐘</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目錄</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#從-mac-使用-container-ip-直連>從 mac 使用 Container Ip 直連</a></li><li><a href=#基本環境說明>基本環境說明</a></li><li><a href=#設定方式>設定方式</a></li><li><a href=#心得>心得</a></li><li><a href=#參考資訊>參考資訊</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=從-mac-使用-container-ip-直連>從 mac 使用 Container Ip 直連</h2><p>大約一年前開發環境從 Windows 轉換至 mac 後，開發上最痛苦的就是沒有 Visual Studio 可以用，痛苦指數第二高的我個人認為是 Docker for Mac 沒有 docker0 網卡 (這是已知的限制：<a href=https://docs.docker.com/docker-for-mac/networking/#known-limitations-use-cases-and-workarounds target=_blank>Networking features in Docker Desktop for Mac - Known limitations, use cases, and workarounds</a> )，雖然很多事還是有 workaround 也可以透過許多技巧避開，但我在意的是這些 workaround 與技巧讓 Docker for Mac 的行為與實際 production 環境可能不同</p><p>之前有網友在看了 <a href=https://blog.yowko.com/redis-cluster-docker/>使用 docker 建立 Redis Cluster - 更新版</a> 後詢問有沒有辦法讓 redis cluster 可以從外部直連，後來同事也遇到類似問題，心想如果是 linux 或是 Windows 只要多個 route rule，大概一分鐘可以搞定，有卡關的想必跟我一樣都是陷入 docker for mac 天生限制的泥淖中，所以就興起了嘗試看看有沒有辦法突破 Docker for Mac 沒有 docker0 網卡 的這樣限制，讓開發人員可以直接在 mac host 上透過 Container Ip 直接存取 Container 上的服務而不是使用 port mapping 的方式</p><p>趁著假日空閒時間終於試出點成果，紀錄一下辛苦的過程(好幾次都差點放棄了)</p><h2 id=基本環境說明>基本環境說明</h2><ol><li>macOS Catalina 10.15.1</li><li>Docker Desktop for Mac community 2.1.0.5(40692)</li><li>Kubernetes v1.14.8</li><li>Helm 2.16.1</li><li>Tunnelblick 3.8.1 (build 5400)</li></ol><h2 id=設定方式>設定方式</h2><p>核心概念是在 Docker for Mac 的虛擬機中建立 OpenVPN Server，然後從 mac 使用 VPN 連進去，整個流程可以參考 <a href=http://www.scispike.com/blog/mac-docker-network-tunnel/ target=_blank>MAC DOCKER NETWORK TUNNEL</a> 的圖示</p><p><img src=http://www.scispike.com/wordpress/wp-content/uploads/2016/08/dockerNetwork.png alt=flow></p><blockquote><p>圖片來： <a href=http://www.scispike.com/blog/mac-docker-network-tunnel/ target=_blank>MAC DOCKER NETWORK TUNNEL</a></p></blockquote><ol><li><p>前置作業</p><ul><li><p>啟動任一 container</p><blockquote><p>這邊以 redis 為例</p></blockquote><pre><code class=language-bash>docker run -d --rm --name redisformac redis
</code></pre></li><li><p>取得 redis container ip</p><blockquote><p>這個 ip 記得保留，後面會用到</p></blockquote><pre><code class=language-bash>docker inspect `docker ps | grep redisformac | awk '{print $1}'` | grep '&quot;IPAddress&quot;'
</code></pre></li><li><p>確認連不到</p><p><img src=https://user-images.githubusercontent.com/3851540/71323783-31997100-2512-11ea-9b85-cab236308693.png alt=1pingcontainer></p><p><img src=https://user-images.githubusercontent.com/3851540/71323784-32320780-2512-11ea-8afc-e462f117682f.png alt=2rdmfail></p></li></ul></li><li><p>啟用 Docker for Mac 的 Kubernetes 功能</p><blockquote><p>詳細內容請參考之前筆記 <a href=https://blog.yowko.com/docker-for-mac-kubernetes/>在Docker for Mac 上啟用Kubernetes</a></p></blockquote></li><li><p>安裝 Helm</p><blockquote><p>詳細內容請參考之前筆記 <a href=https://blog.yowko.com/docker-mac-kubernetes-helm/>在 Docker for Mac 啟用 Kubernetes 後安裝 Helm</a></p></blockquote></li><li><p>下載 <a href=https://github.com/pengsrc/docker-for-mac-kubernetes-devkit target=_blank>Development Toolkit for Kubernetes on Docker for Mac</a></p><blockquote><p>雖然說明文件中有提到可以使用 docker-compose 執行 (甚至執行方式更簡單)，但我一直沒有成功</p></blockquote><pre><code class=language-bash>git clone https://github.com/pengsrc/docker-for-mac-kubernetes-devkit.git
</code></pre></li><li><p>調整或建立 volume 用資料夾 (請依需求調整)</p><blockquote><p>依 <code>docker-for-mac-kubernetes-devkit/values.yaml</code> 中的 dirPaths 設定建立指定資料夾</p></blockquote><pre><code class=language-bash>mkdir /tmp/docker-for-mac-openvpn &amp;&amp; mkdir /tmp/openvpn &amp;&amp; /tmp/openvpn/configs
</code></pre></li><li><p>將 <code>docker-for-mac-openvpn/setup.sh</code> 複製至 dirPaths.data 資料夾中</p><pre><code class=language-bash>cp ./docker-for-mac-openvpn/setup.sh /tmp/docker-for-mac-openvpn/setup.sh
</code></pre></li><li><p>將下載的 <code>Development Toolkit for Kubernetes on Docker for Mac</code> 打包為 helm chart</p><pre><code class=language-bash>helm package docker-for-mac-openvpn
</code></pre></li><li><p>使用剛剛打包的 helm chart 安裝 <code>docker-for-mac-openvpn</code></p><pre><code class=language-bash>helm install docker-for-mac-openvpn-0.1.0.tgz -n docker-for-mac-openvpn
</code></pre></li><li><p>編緝 <code>docker-for-mac-kubernetes-devkit/values.yaml</code> 中l dirPaths.local 資料夾中的 <code>docker-for-mac.ovpn</code></p><blockquote><p><code>docker-for-mac.ovpn</code> 會在 VPN Server 成功建立後生成；請依需求加入想要連線的 container ip route</p></blockquote><pre><code class=language-txt>route 172.17.0.0 255.255.0.0
</code></pre></li><li><p>下載並安裝 <code>Tunnelblick</code></p><blockquote><p>這是 VPN Client；請至 <a href=https://tunnelblick.net/downloads.html target=_blank>Tunnelblick</a> 下載，並執行安裝</p></blockquote></li><li><p>設定 <code>Tunnelblick</code></p><blockquote><p>啟動 <code>Tunnelblick</code> 後，將上面動作編緝的 <code>docker-for-mac.ovpn</code> 牽曳至 <code>Tunnelblick</code> 的 VPN 設定列表中</p></blockquote><p><img src=https://user-images.githubusercontent.com/3851540/71323785-32320780-2512-11ea-844c-67786c33523b.png alt=3addvpn></p><p><img src=https://user-images.githubusercontent.com/3851540/71323786-32320780-2512-11ea-8686-d5989d853a31.png alt=4vpnlist></p><p><img src=https://user-images.githubusercontent.com/3851540/71323787-32ca9e00-2512-11ea-89fe-6a11b102f99a.png alt=5dockerfoemac></p></li><li><p>啟動 VPN</p><p><img src=https://user-images.githubusercontent.com/3851540/71323788-32ca9e00-2512-11ea-8d86-9f0c1e636df3.png alt=6connect></p><p><img src=https://user-images.githubusercontent.com/3851540/71323789-32ca9e00-2512-11ea-8a13-17a0a8481513.png alt=7setuping></p><p><img src=https://user-images.githubusercontent.com/3851540/71323790-32ca9e00-2512-11ea-9580-699db09cbbe6.png alt=8connected></p></li><li><p>測試連線</p><p><img src=https://user-images.githubusercontent.com/3851540/71323791-33633480-2512-11ea-879c-47bda43cc8bc.png alt=9pingok></p><p><img src=https://user-images.githubusercontent.com/3851540/71323792-33633480-2512-11ea-9a92-4897c97d7b05.png alt=10rdmok></p></li></ol><h2 id=心得>心得</h2><p>今天回過頭做紀錄才發現步驟並不多，但前面我卻花了好多時間才試出一個確認可行的方法XD 雖然我自己也覺得這個解決方式有不少缺點：一定要用 Kubernetes、Helm，無形中技術門檻高了不少，再來是步驟有些繁瑣，不過至少是個可以解決問題的方法，雖不滿意但還可接受，慢慢找時間再研究改善囉，baby step 的學習也是種進步嘛</p><h2 id=參考資訊>參考資訊</h2><ol><li><a href=https://docs.docker.com/docker-for-mac/networking/#known-limitations-use-cases-and-workarounds target=_blank>Networking features in Docker Desktop for Mac - Known limitations, use cases, and workarounds</a></li><li><a href=https://blog.yowko.com/redis-cluster-docker/>使用 docker 建立 Redis Cluster - 更新版</a></li><li><a href=https://blog.yowko.com/docker-for-mac-kubernetes/>在Docker for Mac 上啟用Kubernetes</a></li><li><a href=https://blog.yowko.com/docker-mac-kubernetes-helm/>在 Docker for Mac 啟用 Kubernetes 後安裝 Helm</a></li><li><a href=https://pjw.io/articles/2018/04/25/access-to-the-container-network-of-docker-for-mac/ target=_blank>Docker for Mac 容器网络的直连方法</a></li><li><a href=http://www.scispike.com/blog/mac-docker-network-tunnel/ target=_blank>MAC DOCKER NETWORK TUNNEL</a></li><li><a href=https://github.com/pengsrc/docker-for-mac-kubernetes-devkit target=_blank>Development Toolkit for Kubernetes on Docker for Mac</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>Yowko Tsai</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-12-11</span></p><p class=copyright-item><span class=item-title>授權合約</span>
<span class=item-content>本部落格 (<a href=//blog.yowko.com target=_blank>Yowko&#39;s Notes</a>) 所有的文章內容(包含圖片)，任何轉載行為，必須通知並獲本部落格作者 (<a href=mailto:yowko@yowko.com>Yowko Tsai</a>) 的同意始得轉載,且轉載皆須註明出處與作者。<br><br><div class=separator style=clear:both;text-align:center><a href=//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png imageanchor=1 style=margin-left:1em;margin-right:1em><img border=0 src=//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png></a></div><br>&nbsp;<a href=//blog.yowko.com target=_blank>Yowko&#39;s Notes</a> 由 <a href=https://www.facebook.com/yowko.tsai target=_blank>Yowko Tsai</a> 製作，以<a href=//creativecommons.org/licenses/by-nc-sa/3.0/tw/ target=_blank>創用CC 姓名標示-非商業性-相同方式分享 3.0 台灣 授權條款</a>&nbsp;釋出。</span></p></div><footer class=post-footer><div class=post-tags>標籤：
<a href=https://blog.yowko.com/tags/macos/>macOS</a>
<a href=https://blog.yowko.com/tags/tools/>Tools</a>
<a href=https://blog.yowko.com/tags/helm/>Helm</a>
<a href=https://blog.yowko.com/tags/kubernetes/>Kubernetes</a>
<a href=https://blog.yowko.com/tags/docker/>Docker</a></div><nav class=post-nav><div><a class=prev href=https://blog.yowko.com/ios-private-domain/ style=float:none><span class="next-text nav-mobile" style=display:inline-block>下一篇</span>
<i class="fas fa-arrow-circle-right"></i><span class="next-text nav-default">讓 iOS 裝置可以存取自訂 domain</span></a></div><div><a class=prev href=https://blog.yowko.com/docker-mac-kubernetes-helm/ style=float:none><span class="prev-text nav-mobile" style=display:inline-block>上一篇</span>
<i class="fas fa-arrow-circle-left"></i><span class="prev-text nav-default">在 Docker for Mac 啟用 Kubernetes 後安裝 Helm</span></a></div></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url='https:\/\/blog.yowko.com\/mac-access-container-ip-host\/';};(function(){if(window.location.hostname==='localhost')return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='yowkonotes';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:yowko@yowko.com class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/yowko/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/yowko class="iconfont icon-github" title=github></a><a href=https://blog.yowko.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 強力驅動</span>
<span class=division>|</span>
<span class=theme-info>主題 -
<a class=theme-link href=https://github.com/huanlin/hugo-theme-even-more>Even More</a></span>
<span class=copyright-year>&copy;
2016 -
2022
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Yowko Tsai</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="https://blog.yowko.com/lib/highlight/highlight.pack.js?v=20171001"></script><script type=text/javascript src=https://blog.yowko.com/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/instantclick/instantclick-3.0.1.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script type=text/javascript src="https://blog.yowko.com/dist/even.min.js?v=3.2.0"></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-88810280-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>