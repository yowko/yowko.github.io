<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>GKE 透過 Private IP 連線 Cloud SQL - Yowko&#39;s Notes</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content="Yowko Tsai"><meta name=description content="GKE 透過 Private IP 連線 Cloud SQL 因為團隊中沒有傳統 DBA (只有 BA 兼任 DBA 哈哈)，所以在 db 的選擇上一直都偏好使用外部服務 (自建環境時與其他團隊共享 DBA 資源) 所以在評"><meta name=keywords content=yowko,.net,blog><meta name=generator content="Hugo 0.56.3"><meta name=msvalidate.01 content=FA1ADBDB8F0BBBD0F7F4E65CDEBF7898><link rel=canonical href=https://blog.yowko.com/gke-private-sql-cloud-sql/><link rel=apple-touch-icon sizes=180x180 href=https://blog.yowko.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.yowko.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.yowko.com/favicon-16x16.png><link rel=manifest href=https://blog.yowko.com/manifest.json><link rel=mask-icon href=https://blog.yowko.com/safari-pinned-tab.svg color=#5bbad5><link href="https://blog.yowko.com/dist/even.min.css?v=3.2.0" rel=stylesheet><link href=https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.css rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><meta property=og:title content="GKE 透過 Private IP 連線 Cloud SQL"><meta property=og:description content="GKE 透過 Private IP 連線 Cloud SQL 因為團隊中沒有傳統 DBA (只有 BA 兼任 DBA 哈哈)，所以在 db 的選擇上一直都偏好使用外部服務 (自建環境時與其他團隊共享 DBA 資源) 所以在評"><meta property=og:type content=article><meta property=og:url content=https://blog.yowko.com/gke-private-sql-cloud-sql/><meta property=article:published_time content=2020-12-06T21:30:00+08:00><meta property=article:modified_time content=2020-12-11T21:30:31+08:00><meta itemprop=name content="GKE 透過 Private IP 連線 Cloud SQL"><meta itemprop=description content="GKE 透過 Private IP 連線 Cloud SQL 因為團隊中沒有傳統 DBA (只有 BA 兼任 DBA 哈哈)，所以在 db 的選擇上一直都偏好使用外部服務 (自建環境時與其他團隊共享 DBA 資源) 所以在評"><meta itemprop=datePublished content=2020-12-06T21:30:00&#43;08:00><meta itemprop=dateModified content=2020-12-11T21:30:31&#43;08:00><meta itemprop=wordCount content=573><meta itemprop=keywords content=GCP,Kubernetes,><meta name=twitter:card content=summary><meta name=twitter:title content="GKE 透過 Private IP 連線 Cloud SQL"><meta name=twitter:description content="GKE 透過 Private IP 連線 Cloud SQL 因為團隊中沒有傳統 DBA (只有 BA 兼任 DBA 哈哈)，所以在 db 的選擇上一直都偏好使用外部服務 (自建環境時與其他團隊共享 DBA 資源) 所以在評"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><link href=https://blog.yowko.com/opensearch.xml rel=search title="Content search" type=application/opensearchdescription+xml></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=https://blog.yowko.com/ class=logo>Yowko&#39;s Notes</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=https://blog.yowko.com/><li class=mobile-menu-item>首頁</li></a><a href=https://blog.yowko.com/post/><li class=mobile-menu-item>歷史筆記</li></a><a href=https://blog.yowko.com/tags/><li class=mobile-menu-item>內容標籤</li></a><a href=https://blog.yowko.com/search><li class=mobile-menu-item>站內搜尋</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header style=height:118px;padding-bottom:0><div class=logo-wrapper><a href=https://blog.yowko.com/ class=logo>Yowko&#39;s Notes</a></div><div style=padding-bottom:60px></div></nav><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/>首頁</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/post/>歷史筆記</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/tags/>內容標籤</a></li><li class=menu-item><a class=menu-item-link href=https://blog.yowko.com/search>站內搜尋</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><hr style="border-top:1px solid #e6e6e6;border-bottom:0;padding:0"><div id=content class=content><article class=post><header class=post-header><div class=post-meta><span class=post-time>2020-12-06</span>
<span class=more-meta>約 573 字</span>
<span class=more-meta>預計閱讀 2 分鐘</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目錄</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#gke-透過-private-ip-連線-cloud-sql>GKE 透過 Private IP 連線 Cloud SQL</a></li><li><a href=#基本環境說明>基本環境說明</a></li><li><a href=#設定方式>設定方式</a></li><li><a href=#驗證方式>驗證方式</a></li><li><a href=#心得>心得</a></li><li><a href=#參考資訊>參考資訊</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=gke-透過-private-ip-連線-cloud-sql>GKE 透過 Private IP 連線 Cloud SQL</h2><p>因為團隊中沒有傳統 DBA (只有 BA 兼任 DBA 哈哈)，所以在 db 的選擇上一直都偏好使用外部服務 (自建環境時與其他團隊共享 DBA 資源) 所以在評估 GCP 時也就選擇使用 Cloud SQL，當然使用 SaaS 服務的限制： 1. 沒辦法進行細微設定 2. 底層 patch 可控程度低 3. 語法受限 4. 硬體效能受限 5. 價格昂貴 &hellip;. 等等，都已經被納入評估，最後決定因素主要還是在 <code>便利</code> 與 <code>彈性</code>，GCP 管理大多數情況下應該會優於外行人管理吧 XD</p><p>我 google 了一下，網路上的文章跟官方建議都使用 Cloud SQL Proxy 為主，雖然我認同 Cloud SQLProxy 的安全性，但我覺得部署與設定的動作太多了，對測試環境還是 on-premiss 機房的我們而已，要兼容修改的範圍過大，所以才想從網路這層著手</p><h2 id=基本環境說明>基本環境說明</h2><ol><li>GKE (1.17.13-gke.2001)</li><li>Cloud SQL (MySQL 8.0)</li></ol><h2 id=設定方式>設定方式</h2><ol><li><p>建立 GKE (已有 GKE instance 可忽略)</p><ul><li><p>建立叢集</p><p><img src=https://user-images.githubusercontent.com/3851540/101283015-2cacfa80-3813-11eb-94cf-a13a3743d026.png alt=1create-gke></p></li><li><p>設定 Kubernetes networking</p><blockquote><p>使用 <code>default</code> VPC</p></blockquote><p><img src=https://user-images.githubusercontent.com/3851540/101283020-30d91800-3813-11eb-8bb2-25d51b5bac5d.png alt=2networking></p></li></ul></li><li><p>建立 Cloud SQL</p><ul><li><p>建立執行個體</p><p><img src=https://user-images.githubusercontent.com/3851540/101283021-3171ae80-3813-11eb-9882-693de8d40c96.png alt=3createcloudsql></p></li><li><p>選擇資料庫引擎</p><blockquote><p>這邊以 <code>mysql</code> 為例</p></blockquote><p><img src=https://user-images.githubusercontent.com/3851540/101283023-320a4500-3813-11eb-88f8-f3b512606b3d.png alt=4dbengine></p></li><li><p>設定 db networking</p><blockquote><p>使用 <code>Private IP</code> 並指定 <code>default</code> VPC</p></blockquote><p><img src=https://user-images.githubusercontent.com/3851540/101283024-32a2db80-3813-11eb-843f-3b59a47f258f.png alt=5privateip></p></li></ul></li></ol><h2 id=驗證方式>驗證方式</h2><ol><li><p>部署 container</p><blockquote><p>以下使用之前筆記 <a href=https://blog.yowko.com/kubernetes-liveness-aspdotnet-core-grpc/>使用 Kubernetes Liveness 來檢查 ASP.NET Core gRPC 回應合乎預期</a> 的 image 來進行示範</p></blockquote><pre><code class=language-bash>kubectl create deployment test  --image=gcr.io/thermal-setup-295904/healthcheck:healthy
</code></pre></li><li><p>至 container 直接連線</p><ul><li><p>語法</p><pre><code class=language-bash>kubectl exec -it {pod name} -- bash
</code></pre></li><li><p>範例</p><pre><code class=language-bash>kubectl exec -it test-c57fc89dc-jf5dx -- bash
</code></pre></li></ul></li><li><p>安裝 mysql client</p><blockquote><p>請依 base image os 自行調整</p></blockquote><pre><code class=language-bash>apt update &amp;&amp; apt install -y default-mysql-client
</code></pre></li><li><p>使用 Private IP 連線至 Cloud SQL</p><ul><li><p>取得 Cloud SQL Private IP</p><p><img src=https://user-images.githubusercontent.com/3851540/101283026-333b7200-3813-11eb-9d66-0d42ba0fce94.png alt=6getprivateip></p></li><li><p>語法</p><pre><code class=language-bash>mysql -h {cloud sql private ip} -u{username} -p{passowrd}
</code></pre></li><li><p>範例</p><pre><code class=language-bash>mysql -h 10.65.195.3 -uroot -ppass.123
</code></pre></li><li><p>實際結果</p><p><img src=https://user-images.githubusercontent.com/3851540/101283027-333b7200-3813-11eb-85f2-7e002e3d5b12.png alt=7result></p></li></ul></li></ol><h2 id=心得>心得</h2><p>經過一連串測試調整一直遇到連線不通的問題，後來重新看了說明文件才發現漏看了一段重點 @@&rdquo;</p><p><img src=https://user-images.githubusercontent.com/3851540/101283028-33d40880-3813-11eb-8cf7-2defe4ee4190.png alt=8samevpc></p><p>這充份說明：別自以為是，不管做什麼還是需要閱讀公開說明書XD</p><h2 id=參考資訊>參考資訊</h2><ol><li><a href=https://cloud.google.com/sql/docs/mysql/connect-kubernetes-engine target=_blank>Connecting from Google Kubernetes Engine</a></li><li><a href=https://blog.yowko.com/kubernetes-liveness-aspdotnet-core-grpc/>使用 Kubernetes Liveness 來檢查 ASP.NET Core gRPC 回應合乎預期</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>Yowko Tsai</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-12-11</span></p><p class=copyright-item><span class=item-title>授權合約</span>
<span class=item-content>本部落格 (<a href=//blog.yowko.com target=_blank>Yowko&#39;s Notes</a>) 所有的文章內容(包含圖片)，任何轉載行為，必須通知並獲本部落格作者 (<a href=mailto:yowko@yowko.com>Yowko Tsai</a>) 的同意始得轉載,且轉載皆須註明出處與作者。<br><br><div class=separator style=clear:both;text-align:center><a href=//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png imageanchor=1 style=margin-left:1em;margin-right:1em><img border=0 src=//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png></a></div><br>&nbsp;<a href=//blog.yowko.com target=_blank>Yowko&#39;s Notes</a> 由 <a href=https://www.facebook.com/yowko.tsai target=_blank>Yowko Tsai</a> 製作，以<a href=//creativecommons.org/licenses/by-nc-sa/3.0/tw/ target=_blank>創用CC 姓名標示-非商業性-相同方式分享 3.0 台灣 授權條款</a>&nbsp;釋出。</span></p></div><footer class=post-footer><div class=post-tags>標籤：
<a href=https://blog.yowko.com/tags/gcp/>GCP</a>
<a href=https://blog.yowko.com/tags/kubernetes/>Kubernetes</a></div><nav class=post-nav><div><a class=prev href=https://blog.yowko.com/install-mysql-client-only/ style=float:none><span class="next-text nav-mobile" style=display:inline-block>下一篇</span>
<i class="fas fa-arrow-circle-right"></i><span class="next-text nav-default">安裝 mysql client</span></a></div><div><a class=prev href=https://blog.yowko.com/gke-filestore-nfs-client/ style=float:none><span class="prev-text nav-mobile" style=display:inline-block>上一篇</span>
<i class="fas fa-arrow-circle-left"></i><span class="prev-text nav-default">使用 gcloud shell 建立 GKE 並使用 Filestore 做為 NFS-Client</span></a></div></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url='https:\/\/blog.yowko.com\/gke-private-sql-cloud-sql\/';};(function(){if(window.location.hostname==='localhost')return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='yowkonotes';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:yowko@yowko.com class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/yowko/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/yowko class="iconfont icon-github" title=github></a><a href=https://blog.yowko.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 強力驅動</span>
<span class=division>|</span>
<span class=theme-info>主題 -
<a class=theme-link href=https://github.com/huanlin/hugo-theme-even-more>Even More</a></span>
<span class=copyright-year>&copy;
2016 -
2022
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Yowko Tsai</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="https://blog.yowko.com/lib/highlight/highlight.pack.js?v=20171001"></script><script type=text/javascript src=https://blog.yowko.com/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.js></script><script type=text/javascript src=https://blog.yowko.com/lib/instantclick/instantclick-3.0.1.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script type=text/javascript src="https://blog.yowko.com/dist/even.min.js?v=3.2.0"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-7PF6W2W48Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-7PF6W2W48Y');</script></body></html>