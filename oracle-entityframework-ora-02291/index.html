<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤 - Yowko&#39;s Notes</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Yowko Tsai" />
  <meta name="description" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤 之前文章 Oracle 如何做到 SQL Server 的 Identity 欄位型態 介紹到在 Oracle 將 table 欄位設定成模擬 SQL Server Identity 的做法，但實際使用上卻發現某些 table 寫入時卻出現" />

  <meta name="keywords" content="yowko, .net, blog" />






<meta name="generator" content="Hugo 0.55.0" />

<meta name="msvalidate.01" content="FA1ADBDB8F0BBBD0F7F4E65CDEBF7898" />


<link rel="canonical" href="https://blog.yowko.com/oracle-entityframework-ora-02291/" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.yowko.com/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.yowko.com/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.yowko.com/favicon-16x16.png">
<link rel="manifest" href="https://blog.yowko.com/manifest.json">
<link rel="mask-icon" href="https://blog.yowko.com/safari-pinned-tab.svg" color="#5bbad5">







<link href="https://blog.yowko.com/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">




<meta property="og:title" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤" />
<meta property="og:description" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤 之前文章 Oracle 如何做到 SQL Server 的 Identity 欄位型態 介紹到在 Oracle 將 table 欄位設定成模擬 SQL Server Identity 的做法，但實際使用上卻發現某些 table 寫入時卻出現" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.yowko.com/oracle-entityframework-ora-02291/" />
<meta property="article:published_time" content="2017-10-29T01:31:00&#43;08:00"/>
<meta property="article:modified_time" content="2018-09-27T01:31:37&#43;08:00"/>

<meta itemprop="name" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤">
<meta itemprop="description" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤 之前文章 Oracle 如何做到 SQL Server 的 Identity 欄位型態 介紹到在 Oracle 將 table 欄位設定成模擬 SQL Server Identity 的做法，但實際使用上卻發現某些 table 寫入時卻出現">


<meta itemprop="datePublished" content="2017-10-29T01:31:00&#43;08:00" />
<meta itemprop="dateModified" content="2018-09-27T01:31:37&#43;08:00" />
<meta itemprop="wordCount" content="541">



<meta itemprop="keywords" content="Debug,Entity Framework,Oracle," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤"/>
<meta name="twitter:description" content="Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤 之前文章 Oracle 如何做到 SQL Server 的 Identity 欄位型態 介紹到在 Oracle 將 table 欄位設定成模擬 SQL Server Identity 的做法，但實際使用上卻發現某些 table 寫入時卻出現"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<link href='https://raw.githubusercontent.com/yowko/picsbed/master/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

</head>
<body>
     
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="https://blog.yowko.com/" class="logo">Yowko&#39;s Notes</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="https://blog.yowko.com/">
        <li class="mobile-menu-item">首頁</li>
      </a><a href="https://blog.yowko.com/post/">
        <li class="mobile-menu-item">歷史筆記</li>
      </a><a href="https://blog.yowko.com/tags/">
        <li class="mobile-menu-item">內容標籤</li>
      </a><a href="https://blog.yowko.com/search">
        <li class="mobile-menu-item">站內搜尋</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header" style="height: 118px; padding-bottom: 0px;">
        <div class="logo-wrapper">
  <a href="https://blog.yowko.com/" class="logo">Yowko&#39;s Notes</a>
</div>
<div style="padding-bottom: 60px;"> </div>
</nav>
<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="https://blog.yowko.com/">首頁</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="https://blog.yowko.com/post/">歷史筆記</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="https://blog.yowko.com/tags/">內容標籤</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="https://blog.yowko.com/search">站內搜尋</a>
    </li>
  </ul>
</nav>
    </header>	
    <main id="main" class="main">		
      <div class="content-wrapper">		
		<hr style="border-top: 1px solid #e6e6e6; border-bottom: 0px; padding: 0px;" />
        <div id="content" class="content">		
          <article class="post">
    
    <header class="post-header">
      

      <div class="post-meta">
        <span class="post-time"> 2017-10-29 </span>
        
        <span class="more-meta"> 約 541 字 </span>
          <span class="more-meta"> 預計閱讀 2 分鐘 </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目錄</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#oracle-搭配-entity-framework-寫入資料出現-ora-02291-錯誤">Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤</a>
<ul>
<li><a href="#錯誤訊息">錯誤訊息</a></li>
<li><a href="#情境說明">情境說明</a></li>
<li><a href="#解決方式">解決方式</a></li>
<li><a href="#問題原因">問題原因</a></li>
<li><a href="#心得">心得</a></li>
</ul></li>
<li><a href="#參考資訊">參考資訊</a></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<h1 id="oracle-搭配-entity-framework-寫入資料出現-ora-02291-錯誤">Oracle 搭配 Entity Framework 寫入資料出現 ORA-02291 錯誤</h1>

<p>之前文章 <a href="https://blog.yowko.com/2017/10/oracle-identity.html" target="_blank">Oracle 如何做到 SQL Server 的 Identity 欄位型態</a> 介紹到在 Oracle 將 table 欄位設定成模擬 SQL Server Identity 的做法，但實際使用上卻發現某些 table 寫入時卻出現 <code>ORA-02291: integrity constraint (******.FK_****) violated - parent key not found</code> 錯誤，檢查了不少地方，最後將 SQL statement output 出來直接執行卻未發生錯誤，直覺與 Entity Framework 有關，接著就來看看如何解決與問題發生原因吧</p>

<h2 id="錯誤訊息">錯誤訊息</h2>

<ul>
<li><p>訊息內容</p>

<pre><code>Server Error in '/' Application.

ORA-02291: integrity constraint (TESTIDENTITY.FK_USERPROFILELOG) violated - parent key not found

Description: An unhandled exception occurred during the execution of the current web request. Please review the stack trace for more information about the error and where it originated in the code. 

Exception Details: Oracle.ManagedDataAccess.Client.OracleException: ORA-02291: integrity constraint (TESTIDENTITY.FK_USERPROFILELOG) violated - parent key not found

Source Error: 


Line 54:                 db.USERPROFILE.Add(uSERPROFILE);
Line 55:                 uSERPROFILE.USERPROFILELOG.Add(new USERPROFILELOG() {LOGON =DateTime.Now});
Line 56:                 await db.SaveChangesAsync();
Line 57:                 return RedirectToAction(&quot;Index&quot;);
Line 58:             }

Source File: C:\Users\YowkoTsai\Documents\Visual Studio 2017\Projects\TestPermission\TestIdentity\Controllers\UserProfileController.cs    Line: 56 
</code></pre></li>

<li><p>錯誤截圖</p>

<p><img src="https://user-images.githubusercontent.com/3851540/32136830-e563d8aa-bc47-11e7-8009-bd7e506dcaf6.png" alt="1error" /></p></li>
</ul>

<h2 id="情境說明">情境說明</h2>

<ol>
<li>使用 Entity Framework 連線至 Oracle</li>

<li><p>多個 table 間互有關聯</p>

<p><img src="https://user-images.githubusercontent.com/3851540/32136831-e58bc9aa-bc47-11e7-95ee-77b6fb4b7312.png" alt="2tablerela" /></p></li>

<li><p>寫入資料內容涵蓋多個 table</p>

<p><img src="https://user-images.githubusercontent.com/3851540/32136832-e5b38cec-bc47-11e7-90c5-cae9b74540c2.png" alt="3subobject" /></p></li>
</ol>

<h2 id="解決方式">解決方式</h2>

<ul>
<li><p>將 master table 的 primary key 在 Entity Framework 的對應方式改為 <code>Identity</code></p>

<p><img src="https://user-images.githubusercontent.com/3851540/32136833-e5db71a8-bc47-11e7-93f0-ff426b7167ab.png" alt="4resolve" /></p></li>
</ul>

<h2 id="問題原因">問題原因</h2>

<ol>
<li><p>sub entity 要寫入 db 時需要使用 master table primary key 做為 foreign key，而傳入的 master entity primary key 與 sequence 產生序號不同，造成 foreign key constaint 檢查找不到資料</p>

<ul>
<li><p>實例</p>

<ul>
<li><p>傳入 object 如下</p>

<pre><code>masterentity
{
    Id:12,
    subentity
    {
        Id:999
        MasterId:12
    }
}
</code></pre></li>

<li><p>情況一：sequence Id 12 不存在出現 ORA-02291 錯誤(本次錯誤)</p></li>

<li><p>情況二：sequence Id 12 已建立過，造成 sub entity 對應錯誤(更慘，要特別注意)</p></li>
</ul></li>

<li><p>改為 <code>Identity</code> 後即標記讓欄位由 DB 處理</p></li>
</ul></li>

<li><p>單一資料表不會出現錯誤是因為不需檢查 foreign key constaint</p></li>
</ol>

<h2 id="心得">心得</h2>

<p>問題解決方式 google 後馬上就得到正確解答了，只是解決問題當下一時沒有意會過來真正原因，經過後來仔細回想才真正參透其中的關聯，筆記一下加深印象</p>

<h1 id="參考資訊">參考資訊</h1>

<ol>
<li><a href="https://stackoverflow.com/questions/21843128/entityframework-with-oracle-insert-many-to-many-error" target="_blank">Entity Framework with Oracle Insert many to many error</a></li>
</ol>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Yowko Tsai</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-09-27</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">授權合約</span>
    <span class="item-content">本部落格 (<a href="//blog.yowko.com" target="_blank">Yowko&#39;s Notes</a>) 所有的文章內容(包含圖片)，任何轉載行為，必須通知並獲本部落格作者 (<a href="mailto:yowko@yowko.com">Yowko Tsai</a>) 的同意始得轉載,且轉載皆須註明出處與作者。<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="//i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" /></a></div><br />&nbsp;<a href="//blog.yowko.com" target="_blank">Yowko&#39;s Notes</a> 由 <a href="https://www.facebook.com/yowko.tsai" target="_blank">Yowko Tsai</a> 製作，以<a href="//creativecommons.org/licenses/by-nc-sa/3.0/tw/" target="_blank">創用CC 姓名標示-非商業性-相同方式分享 3.0 台灣 授權條款</a>&nbsp;釋出。</span>
  </p>
</div>

	
	
	
    
    
	
    <footer class="post-footer">
      <div class="post-tags">
		  標籤：
		  
          
		    
		    	
            <a href="https://blog.yowko.com/tags/debug/">Debug</a>
          
		    
		    	
            <a href="https://blog.yowko.com/tags/entity-framework/">Entity Framework</a>
          
		    
		    	
            <a href="https://blog.yowko.com/tags/oracle/">Oracle</a>
          
        </div>

      
      <nav class="post-nav">
        
		  <div>
          <a class="prev" href="https://blog.yowko.com/entityframework-log-sql/" style="float: none;">
            <span class="next-text nav-mobile" style="display: inline-block;">下一篇</span>			
            <i class="fas fa-arrow-circle-right"></i>			
            <span class="next-text nav-default">取得 Entity Framework 存取 DB 時的實際 SQL Script</span>			
          </a>
		  </div>
		  <div>
        
          <a class="prev" href="https://blog.yowko.com/oracle-identity/" style="float: none;">
            <span class="prev-text nav-mobile" style="display: inline-block;">上一篇</span>	  
            <i class="fas fa-arrow-circle-left"></i>
            <span class="prev-text nav-default">Oracle 如何做到 SQL Server 的 Identity 欄位型態</span>			
          </a>
		  </div>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = 'https:\/\/blog.yowko.com\/oracle-entityframework-ora-02291\/';  
      
    };

    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'yowkonotes';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>
	
    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:yowko@yowko.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.facebook.com/yowko.tsai" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://www.linkedin.com/in/yowko/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/yowko" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.yowko.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 強力驅動
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主題 - 
    <a class="theme-link" href="https://github.com/huanlin/hugo-theme-even-more">Even More</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2016 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yowko Tsai</span>
  </span>
</div>
    </footer>
	
    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div> 
  
  
<script src="https://blog.yowko.com/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="https://blog.yowko.com/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://blog.yowko.com/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="https://blog.yowko.com/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
  <script type="text/javascript" src="https://blog.yowko.com/lib/instantclick/instantclick-3.0.1.min.js" data-no-instant></script>


<script data-no-instant>InstantClick.init();</script>


<script type="text/javascript" src="https://blog.yowko.com/dist/even.min.js?v=3.2.0"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88810280-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






  

</body>
</html>
